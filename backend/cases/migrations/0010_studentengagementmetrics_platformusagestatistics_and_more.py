# Generated by Django 4.2.7 on 2025-11-14 16:24

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('templates', '0003_casetemplate_vietnamese_name'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('cases', '0008_rename_cases_casegroup_dept_type_idx_cases_caseg_departm_6f64c9_idx_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='StudentEngagementMetrics',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('total_cases_viewed', models.PositiveIntegerField(default=0, help_text='Tổng số ca bệnh đã xem')),
                ('total_cases_completed', models.PositiveIntegerField(default=0, help_text='Tổng số ca bệnh hoàn thành')),
                ('total_cases_submitted', models.PositiveIntegerField(default=0, help_text='Tổng số ca bệnh đã nộp')),
                ('total_study_time_hours', models.FloatField(default=0.0, help_text='Tổng thời gian học (giờ)')),
                ('average_session_duration_minutes', models.FloatField(default=0.0, help_text='Thời lượng phiên trung bình (phút)')),
                ('last_active_at', models.DateTimeField(blank=True, help_text='Lần hoạt động cuối', null=True)),
                ('total_comments_made', models.PositiveIntegerField(default=0, help_text='Tổng số bình luận')),
                ('total_questions_asked', models.PositiveIntegerField(default=0, help_text='Tổng số câu hỏi')),
                ('total_feedback_received', models.PositiveIntegerField(default=0, help_text='Tổng số phản hồi nhận được')),
                ('average_grade', models.FloatField(blank=True, help_text='Điểm trung bình', null=True)),
                ('highest_grade', models.FloatField(blank=True, help_text='Điểm cao nhất', null=True)),
                ('lowest_grade', models.FloatField(blank=True, help_text='Điểm thấp nhất', null=True)),
                ('improvement_rate', models.FloatField(default=0.0, help_text='Tỷ lệ cải thiện (%)')),
                ('current_streak_days', models.PositiveIntegerField(default=0, help_text='Chuỗi ngày học liên tiếp hiện tại')),
                ('longest_streak_days', models.PositiveIntegerField(default=0, help_text='Chuỗi ngày học liên tiếp dài nhất')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('student', models.OneToOneField(help_text='Sinh viên', limit_choices_to={'role': 'student'}, on_delete=django.db.models.deletion.CASCADE, related_name='engagement_metrics', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Student Engagement Metrics',
                'verbose_name_plural': 'Student Engagement Metrics',
                'db_table': 'cases_studentengagementmetrics',
            },
        ),
        migrations.CreateModel(
            name='PlatformUsageStatistics',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('period_type', models.CharField(choices=[('daily', 'Hàng ngày'), ('weekly', 'Hàng tuần'), ('monthly', 'Hàng tháng')], help_text='Loại chu kỳ', max_length=20)),
                ('period_start', models.DateField(help_text='Ngày bắt đầu chu kỳ')),
                ('period_end', models.DateField(help_text='Ngày kết thúc chu kỳ')),
                ('total_active_users', models.PositiveIntegerField(default=0, help_text='Tổng số người dùng hoạt động')),
                ('total_active_students', models.PositiveIntegerField(default=0, help_text='Tổng số sinh viên hoạt động')),
                ('total_active_instructors', models.PositiveIntegerField(default=0, help_text='Tổng số giảng viên hoạt động')),
                ('new_users', models.PositiveIntegerField(default=0, help_text='Số người dùng mới')),
                ('total_cases_created', models.PositiveIntegerField(default=0, help_text='Tổng số ca bệnh tạo mới')),
                ('total_cases_submitted', models.PositiveIntegerField(default=0, help_text='Tổng số ca bệnh nộp')),
                ('total_cases_reviewed', models.PositiveIntegerField(default=0, help_text='Tổng số ca bệnh xem xét')),
                ('total_case_views', models.PositiveIntegerField(default=0, help_text='Tổng số lượt xem ca bệnh')),
                ('total_comments', models.PositiveIntegerField(default=0, help_text='Tổng số bình luận')),
                ('total_feedback', models.PositiveIntegerField(default=0, help_text='Tổng số phản hồi')),
                ('total_grades_given', models.PositiveIntegerField(default=0, help_text='Tổng số điểm đã chấm')),
                ('average_grade', models.FloatField(blank=True, help_text='Điểm trung bình', null=True)),
                ('average_completion_time_hours', models.FloatField(blank=True, help_text='Thời gian hoàn thành trung bình (giờ)', null=True)),
                ('total_storage_used_mb', models.FloatField(default=0.0, help_text='Dung lượng lưu trữ sử dụng (MB)')),
                ('total_attachments_uploaded', models.PositiveIntegerField(default=0, help_text='Tổng số tệp đính kèm tải lên')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': 'Platform Usage Statistics',
                'verbose_name_plural': 'Platform Usage Statistics',
                'db_table': 'cases_platformusagestatistics',
                'ordering': ['-period_start'],
                'indexes': [models.Index(fields=['period_type', 'period_start'], name='cases_platf_period__4faf81_idx')],
                'unique_together': {('period_type', 'period_start')},
            },
        ),
        migrations.CreateModel(
            name='MedicalTerminologyCheck',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('term', models.CharField(help_text='Thuật ngữ y khoa', max_length=200, unique=True)),
                ('vietnamese_term', models.CharField(help_text='Thuật ngữ tiếng Việt', max_length=200)),
                ('category', models.CharField(help_text='Danh mục (VD: Anatomy, Disease, Procedure)', max_length=100)),
                ('definition', models.TextField(blank=True, help_text='Định nghĩa')),
                ('synonyms', models.JSONField(default=list, help_text='Từ đồng nghĩa')),
                ('is_approved', models.BooleanField(default=True, help_text='Thuật ngữ được phê duyệt')),
                ('requires_context', models.BooleanField(default=False, help_text='Yêu cầu ngữ cảnh cụ thể')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Medical Terminology',
                'verbose_name_plural': 'Medical Terminologies',
                'db_table': 'cases_medicalterminologycheck',
                'ordering': ['term'],
                'indexes': [models.Index(fields=['term'], name='cases_medic_term_218c7f_idx'), models.Index(fields=['category'], name='cases_medic_categor_7fc1cf_idx')],
            },
        ),
        migrations.CreateModel(
            name='CaseValidationRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='Tên quy tắc', max_length=200)),
                ('rule_type', models.CharField(choices=[('required_field', 'Trường bắt buộc'), ('min_length', 'Độ dài tối thiểu'), ('max_length', 'Độ dài tối đa'), ('pattern_match', 'Khớp mẫu'), ('attachment_required', 'Yêu cầu tệp đính kèm'), ('terminology_check', 'Kiểm tra thuật ngữ'), ('learning_objective', 'Mục tiêu học tập')], help_text='Loại quy tắc', max_length=50)),
                ('severity', models.CharField(choices=[('error', 'Lỗi (chặn nộp)'), ('warning', 'Cảnh báo'), ('info', 'Thông tin')], default='error', help_text='Mức độ nghiêm trọng', max_length=20)),
                ('target_field', models.CharField(help_text='Trường áp dụng (VD: title, diagnosis, clinical_history.chief_complaint)', max_length=100)),
                ('rule_config', models.JSONField(default=dict, help_text='Cấu hình quy tắc (min_length, pattern, etc.)')),
                ('applies_to_specialties', models.JSONField(default=list, help_text='Áp dụng cho các chuyên khoa cụ thể')),
                ('is_active', models.BooleanField(default=True, help_text='Quy tắc đang hoạt động')),
                ('error_message_vi', models.TextField(help_text='Thông báo lỗi (tiếng Việt)')),
                ('error_message_en', models.TextField(blank=True, help_text='Thông báo lỗi (tiếng Anh)')),
                ('help_text', models.TextField(blank=True, help_text='Hướng dẫn khắc phục')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('applies_to_templates', models.ManyToManyField(blank=True, help_text='Áp dụng cho các template cụ thể (để trống = tất cả)', related_name='validation_rules', to='templates.casetemplate')),
                ('created_by', models.ForeignKey(help_text='Người tạo quy tắc', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_validation_rules', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Case Validation Rule',
                'verbose_name_plural': 'Case Validation Rules',
                'db_table': 'cases_casevalidationrule',
                'ordering': ['severity', 'name'],
            },
        ),
        migrations.CreateModel(
            name='CaseQualityMetrics',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('clinical_history_completeness', models.FloatField(default=0.0, help_text='Độ hoàn thiện tiền sử lâm sàng')),
                ('examination_completeness', models.FloatField(default=0.0, help_text='Độ hoàn thiện khám lâm sàng')),
                ('investigation_completeness', models.FloatField(default=0.0, help_text='Độ hoàn thiện xét nghiệm')),
                ('diagnosis_completeness', models.FloatField(default=0.0, help_text='Độ hoàn thiện chẩn đoán')),
                ('learning_objectives_completeness', models.FloatField(default=0.0, help_text='Độ hoàn thiện mục tiêu học tập')),
                ('has_attachments', models.BooleanField(default=False, help_text='Có tệp đính kèm')),
                ('attachment_quality_score', models.FloatField(default=0.0, help_text='Điểm chất lượng tệp đính kèm')),
                ('terminology_accuracy', models.FloatField(default=0.0, help_text='Độ chính xác thuật ngữ')),
                ('vietnamese_language_quality', models.FloatField(default=0.0, help_text='Chất lượng tiếng Việt')),
                ('overall_completeness', models.FloatField(default=0.0, help_text='Độ hoàn thiện tổng thể')),
                ('overall_quality', models.FloatField(default=0.0, help_text='Chất lượng tổng thể')),
                ('last_calculated_at', models.DateTimeField(auto_now=True, help_text='Lần tính toán cuối')),
                ('case', models.OneToOneField(help_text='Ca bệnh', on_delete=django.db.models.deletion.CASCADE, related_name='quality_metrics', to='cases.case')),
            ],
            options={
                'verbose_name': 'Case Quality Metrics',
                'verbose_name_plural': 'Case Quality Metrics',
                'db_table': 'cases_casequalitymetrics',
            },
        ),
        migrations.CreateModel(
            name='CaseAnalytics',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('total_views', models.PositiveIntegerField(default=0, help_text='Tổng số lượt xem')),
                ('unique_viewers', models.PositiveIntegerField(default=0, help_text='Số người xem duy nhất')),
                ('average_time_spent_seconds', models.PositiveIntegerField(default=0, help_text='Thời gian xem trung bình (giây)')),
                ('completion_rate', models.FloatField(default=0.0, help_text='Tỷ lệ hoàn thành (%)')),
                ('total_comments', models.PositiveIntegerField(default=0, help_text='Tổng số bình luận')),
                ('total_feedback', models.PositiveIntegerField(default=0, help_text='Tổng số phản hồi từ giảng viên')),
                ('total_shares', models.PositiveIntegerField(default=0, help_text='Số lần chia sẻ')),
                ('bookmark_count', models.PositiveIntegerField(default=0, help_text='Số lần đánh dấu')),
                ('average_grade', models.FloatField(blank=True, help_text='Điểm trung bình', null=True)),
                ('pass_rate', models.FloatField(default=0.0, help_text='Tỷ lệ đạt (%)')),
                ('learning_objective_achievement', models.FloatField(default=0.0, help_text='Tỷ lệ đạt mục tiêu học tập (%)')),
                ('average_rating', models.FloatField(blank=True, help_text='Đánh giá trung bình (1-5)', null=True)),
                ('difficulty_rating', models.FloatField(blank=True, help_text='Đánh giá độ khó (1-5)', null=True)),
                ('relevance_rating', models.FloatField(blank=True, help_text='Đánh giá mức độ liên quan (1-5)', null=True)),
                ('last_viewed_at', models.DateTimeField(blank=True, help_text='Lần xem cuối', null=True)),
                ('last_updated_at', models.DateTimeField(auto_now=True, help_text='Lần cập nhật analytics cuối')),
                ('case', models.OneToOneField(help_text='Ca bệnh được theo dõi', on_delete=django.db.models.deletion.CASCADE, related_name='analytics', to='cases.case')),
            ],
            options={
                'verbose_name': 'Case Analytics',
                'verbose_name_plural': 'Case Analytics',
                'db_table': 'cases_caseanalytics',
            },
        ),
        migrations.CreateModel(
            name='DepartmentAnalytics',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('period_start', models.DateField(help_text='Ngày bắt đầu chu kỳ')),
                ('period_end', models.DateField(help_text='Ngày kết thúc chu kỳ')),
                ('total_students', models.PositiveIntegerField(default=0, help_text='Tổng số sinh viên')),
                ('total_instructors', models.PositiveIntegerField(default=0, help_text='Tổng số giảng viên')),
                ('active_students', models.PositiveIntegerField(default=0, help_text='Số sinh viên hoạt động')),
                ('total_cases', models.PositiveIntegerField(default=0, help_text='Tổng số ca bệnh')),
                ('cases_submitted', models.PositiveIntegerField(default=0, help_text='Số ca bệnh đã nộp')),
                ('cases_reviewed', models.PositiveIntegerField(default=0, help_text='Số ca bệnh đã xem xét')),
                ('average_grade', models.FloatField(blank=True, help_text='Điểm trung bình', null=True)),
                ('pass_rate', models.FloatField(default=0.0, help_text='Tỷ lệ đạt (%)')),
                ('average_completion_rate', models.FloatField(default=0.0, help_text='Tỷ lệ hoàn thành trung bình (%)')),
                ('total_comments', models.PositiveIntegerField(default=0, help_text='Tổng số bình luận')),
                ('total_feedback', models.PositiveIntegerField(default=0, help_text='Tổng số phản hồi')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(help_text='Khoa phòng', on_delete=django.db.models.deletion.CASCADE, related_name='analytics', to='cases.department')),
            ],
            options={
                'verbose_name': 'Department Analytics',
                'verbose_name_plural': 'Department Analytics',
                'db_table': 'cases_departmentanalytics',
                'ordering': ['-period_start'],
                'indexes': [models.Index(fields=['department', 'period_start'], name='cases_depar_departm_5fcd08_idx')],
                'unique_together': {('department', 'period_start')},
            },
        ),
        migrations.CreateModel(
            name='CaseViewLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('viewed_at', models.DateTimeField(auto_now_add=True, help_text='Thời gian xem')),
                ('time_spent_seconds', models.PositiveIntegerField(default=0, help_text='Thời gian xem (giây)')),
                ('completed', models.BooleanField(default=False, help_text='Đã xem hết')),
                ('access_method', models.CharField(choices=[('direct', 'Trực tiếp'), ('search', 'Tìm kiếm'), ('shared', 'Chia sẻ'), ('assignment', 'Bài tập')], default='direct', help_text='Phương thức truy cập', max_length=50)),
                ('device_type', models.CharField(blank=True, help_text='Loại thiết bị', max_length=50)),
                ('ip_address', models.GenericIPAddressField(blank=True, help_text='Địa chỉ IP', null=True)),
                ('case', models.ForeignKey(help_text='Ca bệnh được xem', on_delete=django.db.models.deletion.CASCADE, related_name='view_logs', to='cases.case')),
                ('user', models.ForeignKey(help_text='Người xem', on_delete=django.db.models.deletion.CASCADE, related_name='case_views', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Case View Log',
                'verbose_name_plural': 'Case View Logs',
                'db_table': 'cases_caseviewlog',
                'ordering': ['-viewed_at'],
                'indexes': [models.Index(fields=['case', 'user'], name='cases_casev_case_id_117e71_idx'), models.Index(fields=['viewed_at'], name='cases_casev_viewed__d150d1_idx'), models.Index(fields=['user', 'viewed_at'], name='cases_casev_user_id_7aca61_idx')],
            },
        ),
        migrations.CreateModel(
            name='CaseValidationResult',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('validation_status', models.CharField(choices=[('passed', 'Đạt'), ('failed', 'Không đạt'), ('warning', 'Cảnh báo'), ('pending', 'Đang chờ')], default='pending', help_text='Trạng thái kiểm tra', max_length=20)),
                ('total_rules_checked', models.PositiveIntegerField(default=0, help_text='Tổng số quy tắc kiểm tra')),
                ('rules_passed', models.PositiveIntegerField(default=0, help_text='Số quy tắc đạt')),
                ('rules_failed', models.PositiveIntegerField(default=0, help_text='Số quy tắc không đạt')),
                ('warnings_count', models.PositiveIntegerField(default=0, help_text='Số cảnh báo')),
                ('validation_issues', models.JSONField(default=list, help_text='Danh sách vấn đề tìm thấy')),
                ('completeness_score', models.FloatField(default=0.0, help_text='Điểm độ hoàn thiện (0-100)')),
                ('quality_score', models.FloatField(default=0.0, help_text='Điểm chất lượng (0-100)')),
                ('overall_score', models.FloatField(default=0.0, help_text='Điểm tổng thể (0-100)')),
                ('validated_at', models.DateTimeField(auto_now_add=True, help_text='Thời gian kiểm tra')),
                ('validation_type', models.CharField(choices=[('automatic', 'Tự động'), ('manual', 'Thủ công'), ('pre_submission', 'Trước khi nộp'), ('review', 'Xem xét')], default='automatic', help_text='Loại kiểm tra', max_length=50)),
                ('case', models.ForeignKey(help_text='Ca bệnh được kiểm tra', on_delete=django.db.models.deletion.CASCADE, related_name='validation_results', to='cases.case')),
                ('validated_by', models.ForeignKey(blank=True, help_text='Người thực hiện kiểm tra (null = tự động)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='performed_validations', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Case Validation Result',
                'verbose_name_plural': 'Case Validation Results',
                'db_table': 'cases_casevalidationresult',
                'ordering': ['-validated_at'],
                'indexes': [models.Index(fields=['case', 'validation_status'], name='cases_casev_case_id_1e23f3_idx'), models.Index(fields=['validated_at'], name='cases_casev_validat_569448_idx')],
            },
        ),
        migrations.CreateModel(
            name='CaseSubmissionWorkflow',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('current_status', models.CharField(choices=[('draft', 'Bản nháp'), ('validation_pending', 'Đang kiểm tra'), ('validation_failed', 'Kiểm tra không đạt'), ('submitted', 'Đã nộp'), ('under_review', 'Đang xem xét'), ('revision_requested', 'Yêu cầu sửa'), ('approved', 'Đã phê duyệt'), ('rejected', 'Từ chối'), ('published', 'Đã xuất bản')], default='draft', help_text='Trạng thái hiện tại', max_length=50)),
                ('submitted_at', models.DateTimeField(blank=True, help_text='Thời gian nộp', null=True)),
                ('review_started_at', models.DateTimeField(blank=True, help_text='Thời gian bắt đầu xem xét', null=True)),
                ('review_completed_at', models.DateTimeField(blank=True, help_text='Thời gian hoàn thành xem xét', null=True)),
                ('approved_at', models.DateTimeField(blank=True, help_text='Thời gian phê duyệt', null=True)),
                ('revision_count', models.PositiveIntegerField(default=0, help_text='Số lần yêu cầu sửa')),
                ('revision_notes', models.TextField(blank=True, help_text='Ghi chú yêu cầu sửa')),
                ('last_revision_requested_at', models.DateTimeField(blank=True, help_text='Lần cuối yêu cầu sửa', null=True)),
                ('rejected_at', models.DateTimeField(blank=True, help_text='Thời gian từ chối', null=True)),
                ('rejection_reason', models.TextField(blank=True, help_text='Lý do từ chối')),
                ('workflow_history', models.JSONField(default=list, help_text='Lịch sử thay đổi trạng thái')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(blank=True, help_text='Người phê duyệt', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_cases', to=settings.AUTH_USER_MODEL)),
                ('assigned_reviewer', models.ForeignKey(blank=True, help_text='Người xem xét được chỉ định', limit_choices_to={'role__in': ['instructor', 'admin']}, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='assigned_case_reviews', to=settings.AUTH_USER_MODEL)),
                ('case', models.OneToOneField(help_text='Ca bệnh', on_delete=django.db.models.deletion.CASCADE, related_name='submission_workflow', to='cases.case')),
                ('submitted_by', models.ForeignKey(blank=True, help_text='Người nộp', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='submitted_cases', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Case Submission Workflow',
                'verbose_name_plural': 'Case Submission Workflows',
                'db_table': 'cases_casesubmissionworkflow',
                'ordering': ['-updated_at'],
                'indexes': [models.Index(fields=['current_status'], name='cases_cases_current_c2e1dc_idx'), models.Index(fields=['assigned_reviewer'], name='cases_cases_assigne_4e0582_idx'), models.Index(fields=['submitted_at'], name='cases_cases_submitt_00356d_idx')],
            },
        ),
    ]
